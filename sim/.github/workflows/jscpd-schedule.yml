name: jscpd-schedule

on:
  schedule:
    - cron: '0 4 * * *'  # daily at 04:00 UTC
  workflow_dispatch: {}

jobs:
  run-jscpd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build python3 python3-pip

      - name: Configure & Build
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release && cmake --build build --config Release -- -j$(nproc)

      - name: Install jscpd
        run: |
          sudo npm install -g jscpd || true
        env:
          PATH: /usr/local/bin:${{ env.PATH }}

      - name: Run jscpd
        run: |
          mkdir -p reports/jscpd
          jscpd --reporters json --output reports/jscpd --languages c,c++ --skip-dirs build || true

      - name: Summarize jscpd report
        run: |
          python3 tools/jscpd_summary.py || true

      - name: Upload jscpd report and summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jscpd-report
          path: reports/jscpd
